var state_js=require("./lib/state.js");function buildStateMachine(a){return new state_js.StateMachine(a)}function buildRegion(a,d){return new state_js.Region(a,d)}function buildInitialState(a,d){return new state_js.PseudoState(a,state_js.PseudoStateKind.Initial,d)}function buildFinalState(a,d){return new state_js.PseudoState(a,state_js.PseudoStateKind.Final,d)}function buildHistoryState(a,d){return new state_js.PseudoState(a,state_js.PseudoStateKind.ShallowHistory,d)}
function buildSimpleState(a,d){return new state_js.SimpleState(a,d)}function buildCompositeState(a,d){return new state_js.CompositeState(a,d)}function buildEmptyTransition(a,d){return new state_js.Transition(a,d)}function buildTransition(a,d,h){return new state_js.Transition(a,d,h)}function Connector(a,d,h,f){this.client=a;this.server=d;this.clientPort=h;this.serverPort=f}
Connector.prototype.forward=function(a){a=JSON.parse(a);a.port===this.clientPort?(a.port=this.serverPort,this.server._receive(JSON.stringify(a))):(a.port=this.clientPort,this.client._receive(JSON.stringify(a)))};
function MessageSerializer(a,d,h,f,k,g,m,c,b,q,l,e){function s(a){for(var b=0;2>b;b++){var e=a&255;n(e);a=(a-e)/256}}function r(){var a=[],e=q+l[b],c=0,d=0;a[d]=k;for(var d=d+1,t;c<e;){t=l[c];if(t===k||t===g||t===m)a[d]=m,d+=1;a[d]=t;d+=1;c+=1}a[d]=g;return a}function u(a,d){e=0;n(1);n(0);n(0);c=e;n(a);b=e;n(d);e=q=e}function n(a){e===f&&console.log("ERROR: BUFFER OVERFLOW: "+a+" has been ignored. Current index = "+e);e<f&&(l[e]=a,e+=1)}function v(a){a='{"message":"write_bytes","port":"out_c", "b":['+
a+"]}";JSON.parse(a);for(var b=p.length,e=0;e<b;e++)p[e].forward(a)}this.ready=!1;this.PacketManager_lengthInteger__var=a;this.PacketManager_lengthString__var=d;this.PacketManager_lengthUInt16__var=h;this.PacketManager_MAX_PACKET_SIZE__var=f;this.PacketManager_START_BYTE__var=k;this.PacketManager_STOP_BYTE__var=g;this.PacketManager_ESCAPE_BYTE__var=m;this.PacketManager_CODE_POSITION__var=c;this.PacketManager_LENGTH_POSITION__var=b;this.PacketManager_DATA_POSITION__var=q;this.PacketManager_buffer__var=
l;this.PacketManager_index__var=e;var p=[];this.getConnectors=function(){return p};var w=[];this.getQueue=function(){return w};this.serializeInteger=function(a){s(a)};this.serializeUInt16=function(a){s(a)};this.escape=function(){r()};this.send=function(){v(r())};this.setHeader=function(a,b){u(a,b)};this.storeByte=function(a){n(a)};this.readByte=function(){e<f&&(e+=1);e===f&&console.log("ERROR: BUFFER OVERFLOW: trying to read out of buffer boundaries")};this.MessageSerializer_SerializerBehavior=buildStateMachine("SerializerBehavior");
a=buildRegion("_default",this.MessageSerializer_SerializerBehavior);this._initial_MessageSerializer_SerializerBehavior=buildInitialState("_initial",a);a=buildSimpleState("Serialize",a);a.entry=[function(a,b){console.log("Coder ready indeed!")}];new buildEmptyTransition(this._initial_MessageSerializer_SerializerBehavior,a);buildTransition(a,null,function(a,b){var e=JSON.parse(b);return"RemoteControl_c"===e.port&&"changeDisplay"===e.message}).effect=[function(a,b){JSON.parse(b);console.log("Serializing changeDisplay message");
u(20,0);v(r())}]}MessageSerializer.prototype._stop=function(){};MessageSerializer.prototype._init=function(){console.log("Coder ready!");this.MessageSerializer_SerializerBehavior.initialise(this._initial_MessageSerializer_SerializerBehavior);for(var a=this.getQueue().shift();null!=a;)this.MessageSerializer_SerializerBehavior.process(this._initial_MessageSerializer_SerializerBehavior,a),a=this.getQueue().shift();this.ready=!0};
MessageSerializer.prototype._receive=function(a){this.getQueue().push(a);if(this.ready)for(a=this.getQueue().shift();null!=a;)this.MessageSerializer_SerializerBehavior.process(this._initial_MessageSerializer_SerializerBehavior,a),a=this.getQueue().shift()};MessageSerializer.prototype.getName=function(){return"MessageSerializer"};
function WeatherStation(){function a(a){JSON.parse(a);for(var c=h.length,b=0;b<c;b++)h[b].forward(a)}function d(){a('{"message":"changeDisplay","port":"RemoteControlOut_s"}')}this.ready=!1;var h=[];this.getConnectors=function(){return h};var f=[];this.getQueue=function(){return f};var k=[];this.getGuiListeners=function(){return k};this.WeatherStation_SensorsDisplayImpl=buildStateMachine("SensorsDisplayImpl");var g=buildRegion("_default",this.WeatherStation_SensorsDisplayImpl);this._initial_WeatherStation_SensorsDisplayImpl=
buildInitialState("_initial",g);g=buildSimpleState("Process",g);g.entry=[function(d,c){a('{"message":"timer_start","port":"timer_c", "delay":3000}')}];new buildEmptyTransition(this._initial_WeatherStation_SensorsDisplayImpl,g);buildTransition(g,null,function(a,c){var b=JSON.parse(c);return"RemoteControlIn_s"===b.port&&"temperature"===b.message}).effect=[function(d,c){var b=JSON.parse(c);console.log("Temperature is: "+b.temp);b='{"message":"temperature","port":"gui_c", "temp":'+b.temp+"}";a(b);for(var g=
k.length,f=0;f<g;f++)k[f](b)}];buildTransition(g,null,function(a,c){var b=JSON.parse(c);return"RemoteControlIn_s"===b.port&&"light"===b.message}).effect=[function(d,c){var b=JSON.parse(c);console.log("Light is: "+b.light);b='{"message":"light","port":"gui_c", "light":'+b.light+"}";a(b);for(var g=k.length,f=0;f<g;f++)k[f](b)}];buildTransition(g,g,function(a,c){var b=JSON.parse(c);return"timer_c"===b.port&&"timer_timeout"===b.message}).effect=[function(a,c){JSON.parse(c);console.log("Changing Display on Arduino");
d()}];buildTransition(g,null,function(a,c){var b=JSON.parse(c);return"gui_c"===b.port&&"changeDisplay"===b.message}).effect=[function(a,c){JSON.parse(c);console.log("Changing Display on Arduino");d()}]}WeatherStation.prototype._stop=function(){};
WeatherStation.prototype._init=function(){console.log("Weather station ready!");this.WeatherStation_SensorsDisplayImpl.initialise(this._initial_WeatherStation_SensorsDisplayImpl);for(var a=this.getQueue().shift();null!=a;)this.WeatherStation_SensorsDisplayImpl.process(this._initial_WeatherStation_SensorsDisplayImpl,a),a=this.getQueue().shift();this.ready=!0};
WeatherStation.prototype._receive=function(a){this.getQueue().push(a);if(this.ready)for(a=this.getQueue().shift();null!=a;)this.WeatherStation_SensorsDisplayImpl.process(this._initial_WeatherStation_SensorsDisplayImpl,a),a=this.getQueue().shift()};WeatherStation.prototype.getName=function(){return"WeatherStation"};WeatherStation.prototype.receivechangeDisplayOngui=function(){this._receive('{"message":"changeDisplay","port":"gui_c"}')};
function SerialJS(a,d,h,f,k){function g(a){if(19===f[0]&&18===a||18===f[0]){if(19!==a||125===f[k-1])f[k]=a,k+=1;if(19===a&&125!==f[k-1]){a='{"message":"receive_bytes","port":"read_s", "b":['+f+"]}";JSON.parse(a);for(var c=b.length,d=0;d<c;d++)b[d].forward(a);for(a=k=0;18>a;)f[a]=19,a+=1}}}function m(){for(var b=0;18>b;)f[b]=19,b+=1;h=new d.SerialPort(a,{baudrate:9600,parser:d.parsers.byteLength(1)},!1);h.open(function(a){if(a)console.log("ERROR: Problem opening the serial port... It might work, though most likely not :-)");
else h.on("data",function(a){g(a[0])});console.log("Serial port opened sucessfully!")})}function c(){h.close(function(a){a?console.log("ERROR: Problem closing the serial port..."):console.log("serial port closed!")})}this.ready=!1;this.SerialJS_serialPort__var=a;this.SerialJS_lib__var=d;this.SerialJS_serialP__var=h;this.SerialJS_buffer__var=f;this.SerialJS_index__var=k;var b=[];this.getConnectors=function(){return b};var q=[];this.getQueue=function(){return q};this.receive=function(a){g(a)};this.initSerial=
function(){m()};this.killSerial=function(){c()};this.SerialJS_behavior=buildStateMachine("behavior");var l=buildRegion("_default",this.SerialJS_behavior);this._initial_SerialJS_behavior=buildInitialState("_initial",l);l=buildSimpleState("default",l);new buildEmptyTransition(this._initial_SerialJS_behavior,l);buildTransition(l,null,function(a,b){var c=JSON.parse(b);return"write_s"===c.port&&"write_bytes"===c.message}).effect=[function(a,b){var c=JSON.parse(b);h.write(c.b,function(a,b){})}]}
SerialJS.prototype._stop=function(){this.killSerial();console.log("Serial port killed, RIP!")};SerialJS.prototype._init=function(){this.initSerial();console.log("Serial port ready!");this.SerialJS_behavior.initialise(this._initial_SerialJS_behavior);for(var a=this.getQueue().shift();null!=a;)this.SerialJS_behavior.process(this._initial_SerialJS_behavior,a),a=this.getQueue().shift();this.ready=!0};
SerialJS.prototype._receive=function(a){this.getQueue().push(a);if(this.ready)for(a=this.getQueue().shift();null!=a;)this.SerialJS_behavior.process(this._initial_SerialJS_behavior,a),a=this.getQueue().shift()};SerialJS.prototype.getName=function(){return"SerialJS"};
function MessageDeserializer(a,d,h,f,k,g,m,c,b,q,l,e){function s(){e=q;var a=l[c];10===a&&r();11===a&&u()}function r(){var a=n();console.log("t: "+a);x('{"message":"temperature","port":"RemoteControl_c", "temp":'+a+"}")}function u(){var a=n();console.log("l: "+a);x('{"message":"light","port":"RemoteControl_c", "light":'+a+"}")}function n(){for(var a=0,b=1;0<=b;b--)a=256*a+w();return a}function v(a){e=0;var c=q+a[b+1]+1,d=0,f=a[d];if(f===k){var d=d+1,h=a[d];if(h!==g){for(var l=!0;l&&d<c;)f=h,d+=1,
h=a[d],f===m&&(f=h,d+=1,c+=1,h=a[d]),p(f),l=!(h===g&&f!==m);p(f);s()}}}function p(a){e===f&&console.log("ERROR: BUFFER OVERFLOW: "+a+" has been ignored. Current index = "+e);e<f&&(l[e]=a,e+=1)}function w(){var a;e<f&&(a=l[e],e+=1);e===f&&(console.log("ERROR: BUFFER OVERFLOW: trying to read out of buffer boundaries"),a=g);return a}function z(){var a=[],c=q+l[b],d=0,e=0;a[e]=k;for(var e=e+1,f;d<c;){f=l[d];if(f===k||f===g||f===m)a[e]=m,e+=1;a[e]=f;e+=1;d+=1}a[e]=g;return a}function x(a){JSON.parse(a);
for(var b=y.length,c=0;c<b;c++)y[c].forward(a)}this.ready=!1;this.PacketManager_lengthInteger__var=a;this.PacketManager_lengthString__var=d;this.PacketManager_lengthUInt16__var=h;this.PacketManager_MAX_PACKET_SIZE__var=f;this.PacketManager_START_BYTE__var=k;this.PacketManager_STOP_BYTE__var=g;this.PacketManager_ESCAPE_BYTE__var=m;this.PacketManager_CODE_POSITION__var=c;this.PacketManager_LENGTH_POSITION__var=b;this.PacketManager_DATA_POSITION__var=q;this.PacketManager_buffer__var=l;this.PacketManager_index__var=
e;var y=[];this.getConnectors=function(){return y};var A=[];this.getQueue=function(){return A};this.forward=function(){s()};this.deserializeRemote_temperature=function(){r()};this.deserializeRemote_light=function(){u()};this.deserializeInteger=function(){n()};this.deserializeUInt16=function(){n()};this.receive=function(a){v(a)};this.setHeader=function(a,d){e=0;p(1);p(0);p(0);c=e;p(a);b=e;p(d);e=q=e};this.storeByte=function(a){p(a)};this.readByte=function(){w()};this.escape=function(){z()};this.send=
function(){var a=z();x('{"message":"write_bytes","port":"out_c", "b":['+a+"]}")};this.MessageDeserializer_receive=buildStateMachine("receive");a=buildRegion("_default",this.MessageDeserializer_receive);this._initial_MessageDeserializer_receive=buildInitialState("_initial",a);a=buildSimpleState("Idle",a);a.entry=[function(a,b){console.log("Decoder ready indeed!")}];new buildEmptyTransition(this._initial_MessageDeserializer_receive,a);buildTransition(a,null,function(a,b){var c=JSON.parse(b);return"in_c"===
c.port&&"receive_bytes"===c.message}).effect=[function(a,b){var c=JSON.parse(b);console.log("byte[] received from serial. Will try to decode it!...");v(c.b)}]}MessageDeserializer.prototype._stop=function(){};
MessageDeserializer.prototype._init=function(){console.log("Decoder ready!");this.MessageDeserializer_receive.initialise(this._initial_MessageDeserializer_receive);for(var a=this.getQueue().shift();null!=a;)this.MessageDeserializer_receive.process(this._initial_MessageDeserializer_receive,a),a=this.getQueue().shift();this.ready=!0};
MessageDeserializer.prototype._receive=function(a){this.getQueue().push(a);if(this.ready)for(a=this.getQueue().shift();null!=a;)this.MessageDeserializer_receive.process(this._initial_MessageDeserializer_receive,a),a=this.getQueue().shift()};MessageDeserializer.prototype.getName=function(){return"MessageDeserializer"};
function TimerJS(){function a(){clearTimeout(this.timer)}function d(a){console.log("timer.start");this.timer=setTimeout(h,a)}function h(){console.log("timer.onTimeout");JSON.parse('{"message":"timer_timeout","port":"timer_s"}');for(var a=f.length,c=0;c<a;c++)f[c].forward('{"message":"timer_timeout","port":"timer_s"}')}this.ready=!1;var f=[];this.getConnectors=function(){return f};var k=[];this.getQueue=function(){return k};this.cancel=function(){a()};this.start=function(a){d(a)};this.onTimeout=function(){h()};
this.TimerJS_SoftTimer=buildStateMachine("SoftTimer");var g=buildRegion("_default",this.TimerJS_SoftTimer);this._initial_TimerJS_SoftTimer=buildInitialState("_initial",g);g=buildSimpleState("default",g);g.entry=[function(a,c){console.log("debug timer on entry")}];new buildEmptyTransition(this._initial_TimerJS_SoftTimer,g);buildTransition(g,null,function(a,c){var b=JSON.parse(c);return"timer_s"===b.port&&"timer_cancel"===b.message}).effect=[function(d,c){JSON.parse(c);a()}];buildTransition(g,null,
function(a,c){var b=JSON.parse(c);return"timer_s"===b.port&&"timer_start"===b.message&&0<b.delay}).effect=[function(a,c){var b=JSON.parse(c);console.log("debug timer");d(b.delay)}]}TimerJS.prototype._stop=function(){};TimerJS.prototype._init=function(){this.TimerJS_SoftTimer.initialise(this._initial_TimerJS_SoftTimer);for(var a=this.getQueue().shift();null!=a;)this.TimerJS_SoftTimer.process(this._initial_TimerJS_SoftTimer,a),a=this.getQueue().shift();this.ready=!0};
TimerJS.prototype._receive=function(a){this.getQueue().push(a);if(this.ready)for(a=this.getQueue().shift();null!=a;)this.TimerJS_SoftTimer.process(this._initial_TimerJS_SoftTimer,a),a=this.getQueue().shift()};TimerJS.prototype.getName=function(){return"TimerJS"};
var JSWeatherNode_app=new WeatherStation,JSWeatherNode_serializer_buffer_array=[],JSWeatherNode_serializer=new MessageSerializer(2,8,2,16,18,19,125,3,4,5,JSWeatherNode_serializer_buffer_array,0),JSWeatherNode_serial_buffer_array=[],JSWeatherNode_serial=new SerialJS("COM13",require("serialport"),null,JSWeatherNode_serial_buffer_array,0),JSWeatherNode_timer=new TimerJS,JSWeatherNode_deserializer_buffer_array=[],JSWeatherNode_deserializer=new MessageDeserializer(2,8,2,16,18,19,125,3,4,5,JSWeatherNode_deserializer_buffer_array,
0);JSWeatherNode_serializer.getConnectors().push(new Connector(JSWeatherNode_serial,JSWeatherNode_serializer,"write_s","out_c"));JSWeatherNode_serial.getConnectors().push(new Connector(JSWeatherNode_serializer,JSWeatherNode_serial,"out_c","write_s"));JSWeatherNode_serializer.getConnectors().push(new Connector(JSWeatherNode_app,JSWeatherNode_serializer,"RemoteControlOut_s","RemoteControl_c"));
JSWeatherNode_app.getConnectors().push(new Connector(JSWeatherNode_serializer,JSWeatherNode_app,"RemoteControl_c","RemoteControlOut_s"));JSWeatherNode_app.getConnectors().push(new Connector(JSWeatherNode_timer,JSWeatherNode_app,"timer_s","timer_c"));JSWeatherNode_timer.getConnectors().push(new Connector(JSWeatherNode_app,JSWeatherNode_timer,"timer_c","timer_s"));JSWeatherNode_deserializer.getConnectors().push(new Connector(JSWeatherNode_serial,JSWeatherNode_deserializer,"read_s","in_c"));
JSWeatherNode_serial.getConnectors().push(new Connector(JSWeatherNode_deserializer,JSWeatherNode_serial,"in_c","read_s"));JSWeatherNode_deserializer.getConnectors().push(new Connector(JSWeatherNode_app,JSWeatherNode_deserializer,"RemoteControlIn_s","RemoteControl_c"));JSWeatherNode_app.getConnectors().push(new Connector(JSWeatherNode_deserializer,JSWeatherNode_app,"RemoteControl_c","RemoteControlIn_s"));JSWeatherNode_app._init();JSWeatherNode_serializer._init();JSWeatherNode_timer._init();JSWeatherNode_deserializer._init();
JSWeatherNode_serial._init();process.on("SIGINT",function(){JSWeatherNode_app._stop();JSWeatherNode_serial._stop();JSWeatherNode_deserializer._stop();JSWeatherNode_serializer._stop();JSWeatherNode_timer._stop()});
function WebSocketGuiListener(a,d){var h=require("websocket").server,f=require("websocket").client,k=require("http").createServer(function(a,b){console.log(new Date+" Received request for "+a.url);b.writeHead(404);b.end()});k.listen(d,function(){console.log(new Date+" Server is listening on port "+d)});wsServer=new h({httpServer:k,autoAcceptConnections:!1});var g=[];wsServer.on("request",function(a){var b=a.accept(null,a.origin);g.push(b);console.log(new Date+" Connection accepted.");b.on("message",
function(a){if("utf8"===a.type){console.log("Received Message: "+a.utf8Data);for(var b=g.length,c=0;c<b;c++)g[c].sendUTF(a.utf8Data)}});b.on("close",function(a,c){console.log(new Date+" Peer "+b.remoteAddress+" disconnected.");var d=g.indexOf(b);-1<d&&g.splice(d,1)})});var h=new f,m=null;h.on("connectFailed",function(a){console.log("Connect Error: "+a.toString())});h.on("connect",function(c){m=c;console.log("WebSocket client connected");c.on("error",function(a){console.log("Connection Error: "+a.toString())});
c.on("close",function(){console.log("thingml-protocol Connection Closed");m=null});c.on("message",function(b){if("utf8"===b.type){var c;try{c=JSON.parse(b.utf8Data),"gui"===c.port.split("_")[0]&&"changeDisplay"===c.message&&a.receivechangeDisplayOngui(),console.log("Received: '"+b.utf8Data+"'")}catch(d){console.log("JSON: cannot parse "+b.utf8Data)}}})});h.connect("ws://localhost:"+d+"/",null);this.onMessage=function(c){var b;try{b=JSON.parse(c),b.thing=a.getName(),b.port=b.port.split("_")[0],("gui"===
b.port&&"light"===b.message||"temperature"===b.message)&&m.sendUTF(JSON.stringify(b))}catch(d){console.log("JSON: cannot parse "+c)}};this._stop=function(){console.log("Stopping WebSocket...");m.close();wsServer.shutDown();k.close();console.log("Stopping WebSocket... done!")}}var wsGuiListener=new WebSocketGuiListener(JSWeatherNode_app,8080);JSWeatherNode_app.getGuiListeners().push(wsGuiListener.onMessage);process.on("SIGINT",function(){wsGuiListener._stop()});
